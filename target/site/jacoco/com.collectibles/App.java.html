<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>App.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">challenge-6</a> &gt; <a href="index.source.html" class="el_package">com.collectibles</a> &gt; <span class="el_source">App.java</span></div><h1>App.java</h1><pre class="source lang-java linenums">package com.collectibles;

import com.collectibles.exception.NotFoundException;
import com.collectibles.item.ItemController;
import com.collectibles.item.ItemService;
import com.collectibles.offer.OfferService;
import com.collectibles.user.UserController;
import com.collectibles.user.UserService;
import com.collectibles.utils.JsonUtil;
// --- NUEVO IMPORT PARA WEBSOCKET ---
import com.collectibles.websocket.PriceUpdateWebSocketHandler;
// ---
import spark.ModelAndView;
import spark.template.mustache.MustacheTemplateEngine;
import java.util.Map;
import static spark.Spark.*;

<span class="nc" id="L18">public class App {</span>
    public static void main(String[] args) {

<span class="nc" id="L21">        staticFiles.location(&quot;/public&quot;);</span>
<span class="nc" id="L22">        port(8080);</span>

        // --- SPRINT 3.2: INICIALIZAR WEBSOCKET ---
        // Register the WebSocket handler at the /ws/price-updates path
<span class="nc" id="L26">        webSocket(&quot;/ws/price-updates&quot;, PriceUpdateWebSocketHandler.class);</span>
        // ---

<span class="nc" id="L29">        MustacheTemplateEngine templateEngine = new MustacheTemplateEngine();</span>

<span class="nc" id="L31">        ItemService itemService = new ItemService();</span>
<span class="nc" id="L32">        UserService userService = new UserService();</span>
<span class="nc" id="L33">        OfferService offerService = new OfferService();</span>
        
<span class="nc" id="L35">        ItemController itemController = new ItemController(itemService);</span>
<span class="nc" id="L36">        UserController userController = new UserController(userService);</span>
<span class="nc" id="L37">        WebController webController = new WebController(itemService, offerService, templateEngine);</span>


<span class="nc" id="L40">        path(&quot;/api&quot;, () -&gt; {</span>
<span class="nc" id="L41">            itemController.registerRoutes();</span>
<span class="nc" id="L42">            userController.registerRoutes();</span>
<span class="nc" id="L43">        });</span>

<span class="nc" id="L45">        webController.registerRoutes();</span>


        // --- MANEJADORES DE EXCEPCIONES Y FILTROS (SIN CAMBIOS) ---
        
<span class="nc" id="L50">        after(&quot;/api/*&quot;, (req, res) -&gt; {</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">            if (res.type() == null) {</span>
<span class="nc" id="L52">                res.type(&quot;application/json; charset=utf-8&quot;);</span>
            }
<span class="nc" id="L54">        });</span>

<span class="nc" id="L56">        exception(NotFoundException.class, (exception, req, res) -&gt; {</span>
<span class="nc" id="L57">            res.status(404);</span>
<span class="nc" id="L58">            Map&lt;String, Object&gt; model = Map.of(&quot;message&quot;, exception.getMessage());</span>
<span class="nc" id="L59">            res.body(templateEngine.render(new ModelAndView(model, &quot;404.mustache&quot;)));</span>
<span class="nc" id="L60">        });</span>

<span class="nc" id="L62">        exception(Exception.class, (exception, req, res) -&gt; {</span>
<span class="nc" id="L63">            exception.printStackTrace(); </span>
            
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (req.pathInfo().startsWith(&quot;/api/&quot;)) {</span>
<span class="nc" id="L66">                res.status(500);</span>
<span class="nc" id="L67">                res.type(&quot;application/json&quot;);</span>
<span class="nc" id="L68">                res.body(JsonUtil.toJson(Map.of(&quot;error&quot;, &quot;Internal Server Error&quot;)));</span>
<span class="nc" id="L69">            } else {</span>
<span class="nc" id="L70">                res.status(500);</span>
<span class="nc" id="L71">                res.body(&quot;&lt;h1&gt;500 Internal Server Error&lt;/h1&gt;&quot;);</span>
            }
<span class="nc" id="L73">        });</span>
        
<span class="nc" id="L75">        notFound((req, res) -&gt; {</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            if (req.pathInfo().startsWith(&quot;/api/&quot;)) {</span>
<span class="nc" id="L77">                res.status(404);</span>
<span class="nc" id="L78">                res.type(&quot;application/json&quot;);</span>
<span class="nc" id="L79">                return JsonUtil.toJson(Map.of(&quot;error&quot;, &quot;Not Found: &quot; + req.pathInfo()));</span>
            }
            
<span class="nc" id="L82">            res.status(404);</span>
<span class="nc" id="L83">            Map&lt;String, Object&gt; model = Map.of(&quot;message&quot;, &quot;No route matched &quot; + req.pathInfo());</span>
<span class="nc" id="L84">            return templateEngine.render(new ModelAndView(model, &quot;404.mustache&quot;));</span>
        });

<span class="nc" id="L87">        System.out.println(&quot;Servidor API y Web iniciado en http://localhost:8080&quot;);</span>
<span class="nc" id="L88">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>