<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">challenge-6</a> &gt; <a href="index.source.html" class="el_package">com.collectibles</a> &gt; <span class="el_source">WebController.java</span></div><h1>WebController.java</h1><pre class="source lang-java linenums">package com.collectibles;

import com.collectibles.exception.NotFoundException;
import com.collectibles.item.Item;
import com.collectibles.item.ItemService;
import com.collectibles.offer.Offer;
import com.collectibles.offer.OfferService;
// --- ¡CORRECCIÓN AQUÍ! SE AÑADIÓ ESTE IMPORT ---
import com.collectibles.websocket.PriceUpdateWebSocketHandler;
// ---
import spark.ModelAndView;
import spark.TemplateEngine;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import static spark.Spark.*;

public class WebController {

    private final ItemService itemService;
    private final OfferService offerService;
    private final TemplateEngine templateEngine;

<span class="nc" id="L25">    public WebController(ItemService itemService, OfferService offerService, TemplateEngine templateEngine) {</span>
<span class="nc" id="L26">        this.itemService = itemService;</span>
<span class="nc" id="L27">        this.offerService = offerService;</span>
<span class="nc" id="L28">        this.templateEngine = templateEngine;</span>
<span class="nc" id="L29">    }</span>

    public void registerRoutes() {

        // --- (GET / ACTUALIZADO PARA SPRINT 3.1) ---
<span class="nc" id="L34">        get(&quot;/&quot;, (req, res) -&gt; {</span>
<span class="nc" id="L35">            String minPrice = req.queryParams(&quot;minPrice&quot;);</span>
<span class="nc" id="L36">            String maxPrice = req.queryParams(&quot;maxPrice&quot;);</span>

<span class="nc" id="L38">            List&lt;Item&gt; items = itemService.getAllItems(minPrice, maxPrice);</span>
            
<span class="nc" id="L40">            Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</span>
<span class="nc" id="L41">            model.put(&quot;items&quot;, items);</span>
            
<span class="nc" id="L43">            model.put(&quot;minPrice&quot;, minPrice);</span>
<span class="nc" id="L44">            model.put(&quot;maxPrice&quot;, maxPrice);</span>

<span class="nc" id="L46">            return templateEngine.render(new ModelAndView(model, &quot;index.mustache&quot;));</span>
        });

        // --- (GET /:id sin cambios) ---
<span class="nc" id="L50">        get(&quot;/:id&quot;, (req, res) -&gt; {</span>
<span class="nc" id="L51">            String id = req.params(&quot;:id&quot;);</span>
<span class="nc" id="L52">            Optional&lt;Item&gt; itemOpt = itemService.getItemById(id);</span>

<span class="nc bnc" id="L54" title="All 2 branches missed.">            if (itemOpt.isEmpty()) {</span>
<span class="nc" id="L55">                throw new NotFoundException(&quot;Item with ID '&quot; + id + &quot;' not found.&quot;);</span>
            }

<span class="nc" id="L58">            List&lt;Offer&gt; offers = offerService.getOffersByItemId(id);</span>
            
<span class="nc" id="L60">            Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</span>
<span class="nc" id="L61">            model.put(&quot;item&quot;, itemOpt.get());</span>
<span class="nc" id="L62">            model.put(&quot;offers&quot;, offers);</span>

<span class="nc" id="L64">            return templateEngine.render(new ModelAndView(model, &quot;item.mustache&quot;));</span>
        });

        // --- (POST /:id/offer ACTUALIZADO PARA SPRINT 3.2) ---
<span class="nc" id="L68">        post(&quot;/:id/offer&quot;, (req, res) -&gt; {</span>
<span class="nc" id="L69">            String id = req.params(&quot;:id&quot;);</span>
<span class="nc" id="L70">            String bidderName = req.queryParams(&quot;bidderName&quot;);</span>
<span class="nc" id="L71">            String bidderEmail = req.queryParams(&quot;bidderEmail&quot;);</span>
            
<span class="nc" id="L73">            double offerAmount = 0.0;</span>
            try {
<span class="nc" id="L75">                offerAmount = Double.parseDouble(req.queryParams(&quot;offerAmount&quot;));</span>
<span class="nc" id="L76">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L77">                res.redirect(&quot;/&quot; + id);</span>
<span class="nc" id="L78">                return null;</span>
            }

<span class="nc" id="L81">            Offer newOffer = new Offer(bidderName, bidderEmail, id, offerAmount);</span>
<span class="nc" id="L82">            offerService.addOffer(newOffer);</span>
            
<span class="nc" id="L84">            System.out.println(&quot;[OFFER SAVED] Item ID: &quot; + id + </span>
<span class="nc" id="L85">                               &quot;, Bidder: &quot; + bidderName + </span>
<span class="nc" id="L86">                               &quot;, Amount: $&quot; + offerAmount);</span>

            // --- LÓGICA DE WEBSOCKET (SPRINT 3.2) ---
<span class="nc" id="L89">            boolean updated = itemService.updateItemPrice(id, offerAmount);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (updated) {</span>
                // Esta es la línea que fallaba (ahora funciona gracias al import)
<span class="nc" id="L92">                PriceUpdateWebSocketHandler.broadcastPriceUpdate(id, offerAmount);</span>
            }
            // --- FIN LÓGICA WEBSOCKET ---

<span class="nc" id="L96">            res.redirect(&quot;/&quot; + id);</span>
<span class="nc" id="L97">            return null;</span>
        });
<span class="nc" id="L99">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>